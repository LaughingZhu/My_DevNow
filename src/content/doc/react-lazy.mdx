---
title: 'React Lazy çš„å®ç°åŸç†'
desc: 'React Lazy çš„å®ç°åŸç†'
publishDate: '2024-08-07 16:39:36'
image: 'https://cdn.laughingzhu.cn/DevNow/768c2d3cc5b65154103e971083392341-c50fd8.png'
category: 'blog'
author: 'LaughingZhu'
tags: [Blog, React]
---

[React.lazy](https://zh-hans.react.dev/reference/react/lazy) æ˜¯ React 16.6 å¼•å…¥çš„ä¸€ä¸ªç‰¹æ€§ï¼Œç”¨äº **ä»£ç åˆ†å‰²ï¼ˆCode Splittingï¼‰** å’Œ **æŒ‰éœ€åŠ è½½ï¼ˆLazy Loadingï¼‰** ç»„ä»¶ã€‚å®ƒå…è®¸ä½ å®šä¹‰ä¸€ä¸ªåŠ¨æ€åŠ è½½çš„ç»„ä»¶ï¼Œè¿™ä¸ªç»„ä»¶åªæœ‰åœ¨éœ€è¦çš„æ—¶å€™æ‰ä¼šè¢«åŠ è½½ï¼Œä»è€Œå‡å°‘åˆå§‹åŠ è½½æ—¶é—´ï¼Œä¼˜åŒ– [FCP](https://web.dev/articles/fcp?hl=zh-cn) ï¼Œ æé«˜åº”ç”¨æ€§èƒ½ã€‚

## React.lazy çš„å®ç°åŸç†

`React.lazy` çš„æ ¸å¿ƒæ˜¯ä½¿ç”¨ `JavaScript` çš„åŠ¨æ€ [import()](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Operators/import) è¯­æ³•ï¼Œè¿™ç§è¯­æ³•ä¼šè¿”å›ä¸€ä¸ª `Promise` ï¼Œå¹¶ä¸”åœ¨éœ€è¦çš„æ—¶å€™æ‰ä¼šåŠ è½½æ¨¡å—ã€‚ä»¥ä¸‹æ˜¯ `React.lazy` çš„åŸºæœ¬å®ç°åŸç†ï¼š

### 1. åŠ¨æ€å¯¼å…¥ç»„ä»¶ï¼š

`React.lazy` æ¥å—ä¸€ä¸ªå‡½æ•°ä½œä¸ºå‚æ•°ï¼Œè¿™ä¸ªå‡½æ•°ä½¿ç”¨ [import()](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Operators/import) è¯­æ³•åŠ¨æ€å¯¼å…¥ç»„ä»¶ã€‚ä¾‹å¦‚ï¼š

```js
const LazyComponent = React.lazy(() => import('./MyComponent'));
```

### 2. è¿”å›ä¸€ä¸ª React.Componentï¼š

`React.lazy` è¿”å›ä¸€ä¸ªæ–°çš„ React ç»„ä»¶ï¼Œè¿™ä¸ªç»„ä»¶åœ¨å†…éƒ¨ç®¡ç†ç€åŠ è½½çŠ¶æ€ã€‚å½“ç»„ä»¶ç¬¬ä¸€æ¬¡è¢«æ¸²æŸ“æ—¶ï¼Œå®ƒä¼šè§¦å‘ `import()` ï¼Œå¹¶åœ¨åŠ è½½å®Œæˆåæ¸²æŸ“å®é™…çš„ç»„ä»¶ã€‚

### 3. Suspense ç»„ä»¶ï¼š

ä¸ºäº†å¤„ç†åŠ è½½çŠ¶æ€ï¼Œ `React` å¼•å…¥äº† `Suspense` ç»„ä»¶ã€‚ `Suspense` å…è®¸ä½ å®šä¹‰åœ¨ç»„ä»¶åŠ è½½è¿‡ç¨‹ä¸­æ˜¾ç¤ºçš„å ä½å†…å®¹ï¼ˆä¾‹å¦‚ä¸€ä¸ªåŠ è½½æŒ‡ç¤ºå™¨ï¼‰ã€‚å½“åŠ¨æ€å¯¼å…¥çš„ç»„ä»¶æ­£åœ¨åŠ è½½æ—¶ï¼Œ `Suspense` ä¼šæ˜¾ç¤ºå…¶ `fallback` å±æ€§ä¸­å®šä¹‰çš„å†…å®¹ï¼š

```js
<Suspense fallback={<div>Loading...</div>}>
  <LazyComponent />
</Suspense>
```

### 4. å®Œæ•´ç¤ºä¾‹:

```js
import React, { Suspense } from 'react';
const LazyComponent = React.lazy(() => import('./MyComponent'));

function App() {
  return (
    <div>
      <Suspense fallback={<div>Loading...</div>}>
        <LazyComponent />
      </Suspense>
    </div>
  );
}

export default App;
```

## å·¥ä½œæœºåˆ¶

- åˆå§‹æ¸²æŸ“ï¼š

å½“ `LazyComponent` é¦–æ¬¡è¢«æ¸²æŸ“æ—¶ï¼Œ`React.lazy` ä¼šè°ƒç”¨ä¼ å…¥çš„å‡½æ•° `() => import('./MyComponent')` ã€‚
è¿™ä¸ªå‡½æ•°è¿”å›ä¸€ä¸ª `Promise` ï¼Œå½“ `Promise` è§£ææ—¶ï¼Œå®ƒä¼šè¿”å›å®é™…çš„ç»„ä»¶æ¨¡å—ã€‚

- åŠ è½½çŠ¶æ€ç®¡ç†ï¼š

åœ¨ `Promise` è§£æä¹‹å‰ï¼Œ `React.lazy` ä¼šä½¿ç»„ä»¶å¤„äº `"pending"` çŠ¶æ€ã€‚
`Suspense` ç»„ä»¶ä¼šæ£€æµ‹åˆ°è¿™ä¸ª `"pending"` çŠ¶æ€ï¼Œå¹¶æ˜¾ç¤º `fallback` å†…å®¹ï¼ˆå¦‚åŠ è½½æŒ‡ç¤ºå™¨ï¼‰ã€‚

- ç»„ä»¶åŠ è½½å®Œæˆï¼š

ä¸€æ—¦ `Promise` è§£æï¼Œ`React.lazy` ä¼šå°†å®é™…çš„ç»„ä»¶æ¸²æŸ“å‡ºæ¥ã€‚
`Suspense` ç»„ä»¶ä¼šåœæ­¢æ˜¾ç¤º `fallback` å†…å®¹ï¼Œå¹¶æ˜¾ç¤ºåŠ è½½å®Œæˆçš„ç»„ä»¶ã€‚

## æ„å»ºå·¥å…·çš„ä½œç”¨

æ„å»ºå·¥å…·ï¼ˆä¾‹å¦‚ Webpackã€Rollup ç­‰ï¼‰åœ¨å¤„ç†åŠ¨æ€ import() æ—¶ä¼šè‡ªåŠ¨è¿›è¡Œä»£ç åˆ†å‰²ï¼Œå°†åŠ¨æ€å¯¼å…¥çš„æ¨¡å—æ‰“åŒ…æˆå•ç‹¬çš„æ–‡ä»¶ï¼ˆchunkï¼‰ã€‚å½“è¿™äº›æ¨¡å—è¢«è¯·æ±‚æ—¶ï¼Œæµè§ˆå™¨ä¼šæŒ‰éœ€åŠ è½½å¯¹åº”çš„ chunkã€‚

### Webpack ç¤ºä¾‹

Webpack æ˜¯ä¸€ä¸ªå¸¸ç”¨çš„ JavaScript æ¨¡å—æ‰“åŒ…å·¥å…·ï¼Œå®ƒå¯¹åŠ¨æ€ import() æä¾›äº†è‰¯å¥½çš„æ”¯æŒã€‚ä»¥ä¸‹æ˜¯ Webpack å¦‚ä½•å¤„ç†åŠ¨æ€ import() çš„ç¤ºä¾‹ï¼š

1. é…ç½® Webpackï¼šWebpack é»˜è®¤æ”¯æŒåŠ¨æ€ import()ï¼Œä½ åªéœ€è¦ç¡®ä¿é¡¹ç›®çš„ Webpack é…ç½®æ­£ç¡®ã€‚

2. ä»£ç åˆ†å‰²ï¼šå½“ Webpack è§£æåˆ°åŠ¨æ€ import() æ—¶ï¼Œå®ƒä¼šè‡ªåŠ¨åˆ›å»ºä¸€ä¸ªæ–°çš„ chunk æ–‡ä»¶ã€‚ä¾‹å¦‚ï¼š

```js
// src/App.js
import React, { Suspense } from 'react';

const LazyComponent = React.lazy(() => import('./LazyComponent'));

function App() {
  return (
    <div>
      <Suspense fallback={<div>Loading...</div>}>
        <LazyComponent />
      </Suspense>
    </div>
  );
}
export default App;
```

ç¼–è¯‘åï¼ŒWebpack ä¼šç”Ÿæˆä¸€ä¸ªæ–°çš„ chunk æ–‡ä»¶ï¼ˆä¾‹å¦‚ LazyComponent.chunk.jsï¼‰ï¼Œè¿™ä¸ªæ–‡ä»¶åªæœ‰åœ¨ LazyComponent è¢«ä½¿ç”¨æ—¶æ‰ä¼šè¢«åŠ è½½ã€‚

## æ€»ç»“

- åŠ¨æ€ import()ï¼šES6 çš„åŠ¨æ€ import() æ–¹æ³•å…è®¸åœ¨è¿è¡Œæ—¶æŒ‰éœ€åŠ è½½æ¨¡å—ï¼Œè¿”å›ä¸€ä¸ª Promiseã€‚
- React.lazyï¼šåˆ©ç”¨åŠ¨æ€ import() æ–¹æ³•ï¼ŒReact.lazy å¯ä»¥å®šä¹‰æ‡’åŠ è½½ç»„ä»¶ã€‚
- Suspenseï¼šä½¿ç”¨ Suspense ç»„ä»¶å¤„ç†æ‡’åŠ è½½ç»„ä»¶çš„åŠ è½½çŠ¶æ€ï¼Œæ˜¾ç¤ºå ä½å†…å®¹ã€‚
- æ„å»ºå·¥å…·ï¼šå¦‚ Webpack ç­‰æ„å»ºå·¥å…·ä¼šè‡ªåŠ¨è¿›è¡Œä»£ç åˆ†å‰²ï¼Œå°†åŠ¨æ€å¯¼å…¥çš„æ¨¡å—æ‰“åŒ…æˆå•ç‹¬çš„ chunk æ–‡ä»¶ï¼Œå¹¶åœ¨éœ€è¦æ—¶æŒ‰éœ€åŠ è½½ã€‚

é€šè¿‡è¿™äº›æŠ€æœ¯çš„ç»“åˆï¼ŒReact æä¾›äº†ä¸€ç§ç®€å•è€Œå¼ºå¤§çš„æ–¹å¼æ¥å®ç°ä»£ç åˆ†å‰²å’ŒæŒ‰éœ€åŠ è½½ï¼Œä»è€Œæ˜¾è‘—æå‡åº”ç”¨æ€§èƒ½ã€‚

:::tip[æ‰©å±•]
ä¸ä½¿ç”¨ `Suspense` ä¹Ÿå¯ä»¥å®ç°æ‡’åŠ è½½ï¼Œåªæ˜¯ `Suspense` æä¾›äº†ä¸€ç§æ›´ç®€æ´ã€æ›´ä¼˜é›…çš„æ–¹å¼æ¥å¤„ç†åŠ è½½çŠ¶æ€å’Œå ä½å†…å®¹ã€‚å¦‚æœä¸ä½¿ç”¨ `Suspense` ï¼Œä½ éœ€è¦æ‰‹åŠ¨å¤„ç†åŠ è½½çŠ¶æ€å’Œé”™è¯¯è¾¹ç•Œã€‚ä¸ä½¿ç”¨ Suspense çš„æ‡’åŠ è½½ç¤ºä¾‹ï¼š

```js

mport React, { Component } from 'react';

class LazyComponentLoader extends Component {
  state = {
    component: null,
    loading: true,
    error: null,
  };

  componentDidMount() {
    this.loadComponent();
  }

  loadComponent() {
    import('./LazyComponent')
      .then(module => {
        this.setState({ component: module.default, loading: false });
      })
      .catch(error => {
        this.setState({ error, loading: false });
      });
  }

  render() {
    const { component: LoadedComponent, loading, error } = this.state;

    if (loading) {
      return <div>Loading...</div>;
    }

    if (error) {
      return <div>Error loading component</div>;
    }

    return LoadedComponent ? <LoadedComponent /> : null;
  }
}

export default LazyComponentLoader;
```

ä»¥ä¸‹æ˜¯ **é”™è¯¯** çš„å†™æ³•ï¼š

```js
import { lazy } from 'react';

function Editor() {
  // ğŸ”´ Bad: è¿™å°†å¯¼è‡´åœ¨é‡æ–°æ¸²æŸ“æ—¶é‡ç½®æ‰€æœ‰çŠ¶æ€
  const MarkdownPreview = lazy(() => import('./MarkdownPreview.js'));
  // ...
}
```

ä»¥ä¸‹æ˜¯ **æ­£ç¡®** çš„å†™æ³•ï¼š

```js
import { lazy } from 'react';

// âœ… Good: å°† lazy ç»„ä»¶å£°æ˜åœ¨ç»„ä»¶å¤–éƒ¨
const MarkdownPreview = lazy(() => import('./MarkdownPreview.js'));

function Editor() {
  // ...
}
```

æ ¸å¿ƒæ€æƒ³éƒ½æ˜¯åˆ©ç”¨ ES6 çš„åŠ¨æ€ import() æ–¹æ³•æ¥å®ç°æ‡’åŠ è½½ã€‚Suspense åªæ˜¯ä¸ºæ‡’åŠ è½½æä¾›äº†ä¸€ä¸ªæ›´å¥½çš„ç”¨æˆ·ä½“éªŒå’Œæ›´ç®€æ´çš„å®ç°æ–¹å¼ã€‚
:::
